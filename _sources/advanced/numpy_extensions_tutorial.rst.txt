

.. _sphx_glr_advanced_numpy_extensions_tutorial.py:


Creating extensions using numpy and scipy
=========================================
**Author**: `Adam Paszke <https://github.com/apaszke>`_

In this tutorial, we shall go through two tasks:

1. Create a neural network layer with no parameters.

    -  This calls into **numpy** as part of it’s implementation

2. Create a neural network layer that has learnable weights

    -  This calls into **SciPy** as part of it’s implementation



.. code-block:: python


    import torch
    from torch.autograd import Function
    from torch.autograd import Variable







Parameter-less example
----------------------

This layer doesn’t particularly do anything useful or mathematically
correct.

It is aptly named BadFFTFunction

**Layer Implementation**



.. code-block:: python


    from numpy.fft import rfft2, irfft2


    class BadFFTFunction(Function):

        def forward(self, input):
            numpy_input = input.numpy()
            result = abs(rfft2(numpy_input))
            return input.new(result)

        def backward(self, grad_output):
            numpy_go = grad_output.numpy()
            result = irfft2(numpy_go)
            return grad_output.new(result)

    # since this layer does not have any parameters, we can
    # simply declare this as a function, rather than as an nn.Module class


    def incorrect_fft(input):
        return BadFFTFunction()(input)







**Example usage of the created layer:**



.. code-block:: python


    input = Variable(torch.randn(8, 8), requires_grad=True)
    result = incorrect_fft(input)
    print(result.data)
    result.backward(torch.randn(result.size()))
    print(input.grad)





.. rst-class:: sphx-glr-script-out

 Out::

    11.0586   3.8502   9.9399   5.8483   5.3233
     12.4087  11.1920   3.5189   4.6579  13.7862
      6.6967   8.7046  10.0487   7.4146  18.3634
      4.9683   3.4889  11.0392   5.8047   5.9955
      9.7704   2.7805   5.3798   5.9981   5.4626
      4.9683   7.6555   6.3816   7.4920   5.9955
      6.6967   7.9751   4.7790  11.1189  18.3634
     12.4087   6.6047   2.2951  14.0646  13.7862
    [torch.FloatTensor of size 8x5]

    Variable containing:
    -0.0105  0.0085  0.0117 -0.2112 -0.0564 -0.2112  0.0117  0.0085
    -0.0489  0.2564 -0.2409 -0.0716  0.0301  0.0935  0.2950  0.0111
     0.1432  0.1080 -0.1911 -0.0339  0.2254  0.0216 -0.0125 -0.0829
     0.1459 -0.0931 -0.1916 -0.0204 -0.0176  0.0403  0.2889  0.0033
    -0.0940  0.0904 -0.0749 -0.0305  0.1044 -0.0305 -0.0749  0.0904
     0.1459  0.0033  0.2889  0.0403 -0.0176 -0.0204 -0.1916 -0.0931
     0.1432 -0.0829 -0.0125  0.0216  0.2254 -0.0339 -0.1911  0.1080
    -0.0489  0.0111  0.2950  0.0935  0.0301 -0.0716 -0.2409  0.2564
    [torch.FloatTensor of size 8x8]


Parametrized example
--------------------

This implements a layer with learnable weights.

It implements the Cross-correlation with a learnable kernel.

In deep learning literature, it’s confusingly referred to as
Convolution.

The backward computes the gradients wrt the input and gradients wrt the
filter.

**Implementation:**

*Please Note that the implementation serves as an illustration, and we
did not verify it’s correctness*



.. code-block:: python


    from scipy.signal import convolve2d, correlate2d
    from torch.nn.modules.module import Module
    from torch.nn.parameter import Parameter


    class ScipyConv2dFunction(Function):
        @staticmethod
        def forward(ctx, input, filter):
            result = correlate2d(input.numpy(), filter.numpy(), mode='valid')
            ctx.save_for_backward(input, filter)
            return input.new(result)

        @staticmethod
        def backward(ctx, grad_output):
            input, filter = ctx.saved_tensors
            grad_output = grad_output.data
            grad_input = convolve2d(grad_output.numpy(), filter.t().numpy(), mode='full')
            grad_filter = convolve2d(input.numpy(), grad_output.numpy(), mode='valid')

            return Variable(grad_output.new(grad_input)), \
                Variable(grad_output.new(grad_filter))


    class ScipyConv2d(Module):

        def __init__(self, kh, kw):
            super(ScipyConv2d, self).__init__()
            self.filter = Parameter(torch.randn(kh, kw))

        def forward(self, input):
            return ScipyConv2dFunction.apply(input, self.filter)







**Example usage:**



.. code-block:: python


    module = ScipyConv2d(3, 3)
    print(list(module.parameters()))
    input = Variable(torch.randn(10, 10), requires_grad=True)
    output = module(input)
    print(output)
    output.backward(torch.randn(8, 8))
    print(input.grad)




.. rst-class:: sphx-glr-script-out

 Out::

    [Parameter containing:
    -1.0252 -0.1600 -1.1283
     0.7731  0.0674  1.0974
     1.5003 -0.5656 -0.5851
    [torch.FloatTensor of size 3x3]
    ]
    Variable containing:
    -1.2152 -2.4387 -3.8611 -5.1901  4.2051  0.8169  0.4455  0.2533
     0.3768 -1.5424  2.8675  4.2436  1.0639  1.8258 -1.9649  2.4207
     2.5729  0.8296  0.0661 -3.4955  0.5541  2.0485  3.2900 -0.0010
    -2.3646 -3.6673  0.6205  0.7300 -3.7528  1.2965 -7.7575  0.7594
    -1.2418  3.0477  0.6323  0.6175  2.0772 -0.9029  3.9681 -3.3536
    -3.3278  1.9471 -0.6104  1.7971  1.3345  1.9448 -1.9205  1.3055
    -1.5992 -2.0504 -6.2996 -1.1587 -1.7559  1.5805 -5.4323 -0.8916
     3.5078 -0.9442  1.6136 -1.4073  5.4403  1.7607  0.2511  5.8740
    [torch.FloatTensor of size 8x8]

    Variable containing:
    -1.3123  1.0168  3.0082 -0.8300 -4.2262  1.5554  3.8232  0.5046  0.3251  0.1318
     1.0353 -2.4290  0.2088  0.1893 -0.2802  1.6318 -3.5138 -1.6263  1.5921  1.5631
    -0.9677  0.6569  0.3838 -1.9674 -1.2539  2.8798  2.6683  1.5855 -0.5153 -0.4119
     1.5019 -2.9039  3.1668 -4.8196  2.6938 -0.2337  0.1065 -0.3617  2.0915  0.7526
     0.8707 -1.3235 -0.5235  1.0325 -3.7278 -2.4327 -0.2836  0.4655  3.4779 -0.0339
     1.8584 -1.7075 -1.5423  1.3709 -2.7331 -2.6798 -1.2628 -1.9040  2.9855  0.6558
     1.1210 -1.4081  3.0719 -0.7977 -1.7955  2.5143 -6.3617 -1.5777  2.7281  1.3909
     0.6401 -1.2316  3.4488  0.2114  0.0188  2.9650 -0.2735  2.9492 -2.1523 -2.6202
     0.0934 -0.1550  0.4841 -1.0833  0.6971  1.0448 -4.3992  1.5381  0.5689 -0.3897
    -1.3644  1.6249 -2.0271  0.3352 -0.6125 -0.1460  0.5641  0.1758 -0.6574  0.4780
    [torch.FloatTensor of size 10x10]


**Total running time of the script:** ( 0 minutes  0.008 seconds)



.. only :: html

 .. container:: sphx-glr-footer


  .. container:: sphx-glr-download

     :download:`Download Python source code: numpy_extensions_tutorial.py <numpy_extensions_tutorial.py>`



  .. container:: sphx-glr-download

     :download:`Download Jupyter notebook: numpy_extensions_tutorial.ipynb <numpy_extensions_tutorial.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.readthedocs.io>`_
